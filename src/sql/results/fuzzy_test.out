CREATE EXTENSION fuzzy;
CREATE TABLE test_twoints(a INT, b TWOINT);
INSERT INTO test_twoints VALUES (1, '1,20'), (1, '7,-3');
CREATE TABLE test_zadeh(a FLOAT8, b FLOAT8);
INSERT INTO test_zadeh VALUES (0, .3), (.4, .9), (.6, .2), (1, 1), (NULL, 0.5), (0.5, NULL);
SELECT ~a AS neg_a FROM test_zadeh;
 neg_a 
-------
     1
   0.6
   0.4
     0
      
   0.5
(6 rows)

SELECT a|||b AS a_or_b FROM test_zadeh;
 a_or_b 
--------
    0.3
    0.9
    0.6
      1
       
       
(6 rows)

SELECT a&&&b AS a_and_b FROM test_zadeh;
 a_and_b 
---------
       0
     0.4
     0.2
       1
        
        
(6 rows)

CREATE TABLE test_functions(a INT, b TRAPEZOIDAL_FUNCTION);
INSERT INTO test_functions VALUES
  (1, '0.2/0.4~0.6\0.8'),
  (2, '0.2/0.5\0.8'),
  (3, '0.2/0.4~0.8'),
  (4, '0.2/0.5'),
  (5, '0.2~0.8'),
  (6, '0.5'),
  (7, about(-10, 0, 3, 40)),
  (8, almost_none()),
  (9, almost_all()),
  (10, about_a_quarter()),
  (11, about_a_third()),
  (12, about_half()),
  (13, about_two_thirds()),
  (14, about_three_quarters()),
  (15, about_one()),
  (16, about_some()),
  (17, about_a_dozen()),
  (18, about_a_few_dozen()),
  (19, about_a_few_hundred()),
  (20, about_a_minute()),
  (21, about_a_quarter_of_an_hour()),
  (22, about_an_hour()),
  (23, about_a_week()),
  (24, about_a_month()),
  (25, about_a_year()),
  (26, NULL);
CREATE INDEX trapezoidal ON test_functions(b);
SELECT *, seconds_to_str(b), days_to_str(b) FROM test_functions;
 a  |                b                |        seconds_to_str        |           days_to_str           
----+---------------------------------+------------------------------+---------------------------------
  1 | 0.20/0.40~0.60\0.80             | 0.20/0.40~0.60\0.80          | 0.20/0.40~0.60\0.80
  2 | 0.20/0.50~0.50\0.80             | 0.20/0.50~0.50\0.80          | 0.20/0.50~0.50\0.80
  3 | 0.20/0.40~0.80\0.80             | 0.20/0.40~0.80\0.80          | 0.20/0.40~0.80\0.80
  4 | 0.20/0.50~0.50\0.50             | 0.20/0.50~0.50\0.50          | 0.20/0.50~0.50\0.50
  5 | 0.20/0.20~0.80\0.80             | 0.20/0.20~0.80\0.80          | 0.20/0.20~0.80\0.80
  6 | 0.50/0.50~0.50\0.50             | 0.50/0.50~0.50\0.50          | 0.50/0.50~0.50\0.50
  7 | -10.00/0.00~3.00\40.00          | -10.00/0.00~3.00\40.00       | -10.00/0.00~3.00\40.00
  8 | 0.00/0.00~0.05\0.10             | 0.00/0.00~0.05\0.10          | 0.00/0.00~0.05\0.10
  9 | 0.09/0.95~1.00\1.00             | 0.09/0.95~1.00\1.00          | 0.09/0.95~1.00\1.00
 10 | 0.10/0.20~0.30\0.40             | 0.10/0.20~0.30\0.40          | 0.10/0.20~0.30\0.40
 11 | 0.18/0.28~0.38\0.48             | 0.18/0.28~0.38\0.48          | 0.18/0.28~0.38\0.48
 12 | 0.35/0.45~0.55\0.65             | 0.35/0.45~0.55\0.65          | 0.35/0.45~0.55\0.65
 13 | 0.51/0.61~0.71\0.81             | 0.51/0.61~0.71\0.81          | 0.51/0.61~0.71\0.81
 14 | 0.60/0.70~0.80\0.90             | 0.60/0.70~0.80\0.90          | 0.60/0.70~0.80\0.90
 15 | 0.00/1.00~1.00\2.00             | 0.00/1.00~1.00\2.00          | 0.00/1.00~1.00\2.00
 16 | 1.00/3.00~9.00\12.00            | 1.00/3.00~9.00\12.00         | 1.00/3.00~9.00\12.00
 17 | 8.00/12.00~19.00\22.00          | 8.00/12.00~19.00\22.00       | 8.00/12.00~19.00\22.00
 18 | 20.00/30.00~90.00\120.00        | 20.00/30.00~90.00\120.00     | 20.00/30.00~90.00\120.00
 19 | 100.00/300.00~900.00\1200.00    | 100.00/300.00~900.00\1200.00 | 100.00/300.00~900.00\1200.00
 20 | 40.00/60.00~60.00\80.00         | about a minute               | 40.00/60.00~60.00\80.00
 21 | 600.00/900.00~900.00\1200.00    | about a quarter of an hour   | 600.00/900.00~900.00\1200.00
 22 | 2400.00/3600.00~3600.00\4800.00 | about an hour                | 2400.00/3600.00~3600.00\4800.00
 23 | 3.00/7.00~7.00\11.00            | 3.00/7.00~7.00\11.00         | about a week
 24 | 20.00/28.00~31.00\39.00         | 20.00/28.00~31.00\39.00      | about a month
 25 | 160.00/365.00~366.00\570.00     | 160.00/365.00~366.00\570.00  | about a year
 26 |                                 |                              | 
(26 rows)

-- SUM
SELECT b+1 AS b_plus_one, 1+b AS one_plus_b FROM test_functions;
           b_plus_one            |           one_plus_b            
---------------------------------+---------------------------------
 1.20/1.40~1.60\1.80             | 1.20/1.40~1.60\1.80
 1.20/1.50~1.50\1.80             | 1.20/1.50~1.50\1.80
 1.20/1.40~1.80\1.80             | 1.20/1.40~1.80\1.80
 1.20/1.50~1.50\1.50             | 1.20/1.50~1.50\1.50
 1.20/1.20~1.80\1.80             | 1.20/1.20~1.80\1.80
 1.50/1.50~1.50\1.50             | 1.50/1.50~1.50\1.50
 -9.00/1.00~4.00\41.00           | -9.00/1.00~4.00\41.00
 1.00/1.00~1.05\1.10             | 1.00/1.00~1.05\1.10
 1.09/1.95~2.00\2.00             | 1.09/1.95~2.00\2.00
 1.10/1.20~1.30\1.40             | 1.10/1.20~1.30\1.40
 1.18/1.28~1.38\1.48             | 1.18/1.28~1.38\1.48
 1.35/1.45~1.55\1.65             | 1.35/1.45~1.55\1.65
 1.51/1.61~1.71\1.81             | 1.51/1.61~1.71\1.81
 1.60/1.70~1.80\1.90             | 1.60/1.70~1.80\1.90
 1.00/2.00~2.00\3.00             | 1.00/2.00~2.00\3.00
 2.00/4.00~10.00\13.00           | 2.00/4.00~10.00\13.00
 9.00/13.00~20.00\23.00          | 9.00/13.00~20.00\23.00
 21.00/31.00~91.00\121.00        | 21.00/31.00~91.00\121.00
 101.00/301.00~901.00\1201.00    | 101.00/301.00~901.00\1201.00
 41.00/61.00~61.00\81.00         | 41.00/61.00~61.00\81.00
 601.00/901.00~901.00\1201.00    | 601.00/901.00~901.00\1201.00
 2401.00/3601.00~3601.00\4801.00 | 2401.00/3601.00~3601.00\4801.00
 4.00/8.00~8.00\12.00            | 4.00/8.00~8.00\12.00
 21.00/29.00~32.00\40.00         | 21.00/29.00~32.00\40.00
 161.00/366.00~367.00\571.00     | 161.00/366.00~367.00\571.00
                                 | 
(26 rows)

-- SUB
SELECT b-1 AS b_minus_one, 1-b AS one_minus_b FROM test_functions;
           b_minus_one           |             one_minus_b             
---------------------------------+-------------------------------------
 -0.80/-0.60~-0.40\-0.20         | 0.20/0.40~0.60\0.80
 -0.80/-0.50~-0.50\-0.20         | 0.20/0.50~0.50\0.80
 -0.80/-0.60~-0.20\-0.20         | 0.20/0.20~0.60\0.80
 -0.80/-0.50~-0.50\-0.50         | 0.50/0.50~0.50\0.80
 -0.80/-0.80~-0.20\-0.20         | 0.20/0.20~0.80\0.80
 -0.50/-0.50~-0.50\-0.50         | 0.50/0.50~0.50\0.50
 -11.00/-1.00~2.00\39.00         | -39.00/-2.00~1.00\11.00
 -1.00/-1.00~-0.95\-0.90         | 0.90/0.95~1.00\1.00
 -0.91/-0.05~0.00\0.00           | -0.00/-0.00~0.05\0.91
 -0.90/-0.80~-0.70\-0.60         | 0.60/0.70~0.80\0.90
 -0.82/-0.72~-0.62\-0.52         | 0.52/0.62~0.72\0.82
 -0.65/-0.55~-0.45\-0.35         | 0.35/0.45~0.55\0.65
 -0.49/-0.39~-0.29\-0.19         | 0.19/0.29~0.39\0.49
 -0.40/-0.30~-0.20\-0.10         | 0.10/0.20~0.30\0.40
 -1.00/0.00~0.00\1.00            | -1.00/-0.00~0.00\1.00
 0.00/2.00~8.00\11.00            | -11.00/-8.00~-2.00\0.00
 7.00/11.00~18.00\21.00          | -21.00/-18.00~-11.00\-7.00
 19.00/29.00~89.00\119.00        | -119.00/-89.00~-29.00\-19.00
 99.00/299.00~899.00\1199.00     | -1199.00/-899.00~-299.00\-99.00
 39.00/59.00~59.00\79.00         | -79.00/-59.00~-59.00\-39.00
 599.00/899.00~899.00\1199.00    | -1199.00/-899.00~-899.00\-599.00
 2399.00/3599.00~3599.00\4799.00 | -4799.00/-3599.00~-3599.00\-2399.00
 2.00/6.00~6.00\10.00            | -10.00/-6.00~-6.00\-2.00
 19.00/27.00~30.00\38.00         | -38.00/-30.00~-27.00\-19.00
 159.00/364.00~365.00\569.00     | -569.00/-365.00~-364.00\-159.00
                                 | 
(26 rows)

-- MUL
SELECT b*2 AS b_mul_two, 2*b AS two_mul_b FROM test_functions;
            b_mul_two            |            two_mul_b            
---------------------------------+---------------------------------
 0.40/0.80~1.20\1.60             | 0.40/0.80~1.20\1.60
 0.40/1.00~1.00\1.60             | 0.40/1.00~1.00\1.60
 0.40/0.80~1.60\1.60             | 0.40/0.80~1.60\1.60
 0.40/1.00~1.00\1.00             | 0.40/1.00~1.00\1.00
 0.40/0.40~1.60\1.60             | 0.40/0.40~1.60\1.60
 1.00/1.00~1.00\1.00             | 1.00/1.00~1.00\1.00
 -20.00/0.00~6.00\80.00          | -20.00/0.00~6.00\80.00
 0.00/0.00~0.10\0.20             | 0.00/0.00~0.10\0.20
 0.18/1.90~2.00\2.00             | 0.18/1.90~2.00\2.00
 0.20/0.40~0.60\0.80             | 0.20/0.40~0.60\0.80
 0.36/0.56~0.76\0.96             | 0.36/0.56~0.76\0.96
 0.70/0.90~1.10\1.30             | 0.70/0.90~1.10\1.30
 1.02/1.22~1.42\1.62             | 1.02/1.22~1.42\1.62
 1.20/1.40~1.60\1.80             | 1.20/1.40~1.60\1.80
 0.00/2.00~2.00\4.00             | 0.00/2.00~2.00\4.00
 2.00/6.00~18.00\24.00           | 2.00/6.00~18.00\24.00
 16.00/24.00~38.00\44.00         | 16.00/24.00~38.00\44.00
 40.00/60.00~180.00\240.00       | 40.00/60.00~180.00\240.00
 200.00/600.00~1800.00\2400.00   | 200.00/600.00~1800.00\2400.00
 80.00/120.00~120.00\160.00      | 80.00/120.00~120.00\160.00
 1200.00/1800.00~1800.00\2400.00 | 1200.00/1800.00~1800.00\2400.00
 4800.00/7200.00~7200.00\9600.00 | 4800.00/7200.00~7200.00\9600.00
 6.00/14.00~14.00\22.00          | 6.00/14.00~14.00\22.00
 40.00/56.00~62.00\78.00         | 40.00/56.00~62.00\78.00
 320.00/730.00~732.00\1140.00    | 320.00/730.00~732.00\1140.00
                                 | 
(26 rows)

-- DIV
SELECT b/2 AS b_div_two, 2/b AS two_div_b FROM test_functions;
            b_div_two            |        two_div_b         
---------------------------------+--------------------------
 0.10/0.20~0.30\0.40             | -5.00/5.00~15.00\25.00
 0.10/0.25~0.25\0.40             | 
 0.10/0.20~0.40\0.40             | 
 0.10/0.25~0.25\0.25             | 
 0.10/0.10~0.40\0.40             | 
 0.25/0.25~0.25\0.25             | 
 -5.00/0.00~1.50\20.00           | 
 0.00/0.00~0.03\0.05             | 
 0.04/0.47~0.50\0.50             | 
 0.05/0.10~0.15\0.20             | -10.00/10.00~30.00\50.00
 0.09/0.14~0.19\0.24             | -12.86/7.14~27.14\47.14
 0.17/0.23~0.28\0.33             | -15.56/4.44~24.44\44.44
 0.26/0.30~0.35\0.41             | -16.72/3.28~23.28\43.28
 0.30/0.35~0.40\0.45             | -17.14/2.86~22.86\42.86
 0.00/0.50~0.50\1.00             | 
 0.50/1.50~4.50\6.00             | -0.33/0.67~1.00\1.67
 4.00/6.00~9.50\11.00            | -0.33/0.17~0.45\1.12
 10.00/15.00~45.00\60.00         | -0.13/0.07~0.10\0.17
 50.00/150.00~450.00\600.00      | -0.00/0.01~0.01\0.02
 20.00/30.00~30.00\40.00         | 
 300.00/450.00~450.00\600.00     | 
 1200.00/1800.00~1800.00\2400.00 | 
 1.50/3.50~3.50\5.50             | 
 10.00/14.00~15.50\19.50         | -0.18/0.07~0.74\0.99
 80.00/182.50~183.00\285.00      | -0.00/0.01~2.01\2.02
                                 | 
(26 rows)

-- NEG
SELECT -b*2 AS neg_b FROM test_functions;
                neg_b                
-------------------------------------
 -1.60/-1.20~-0.80\-0.40
 -1.60/-1.00~-1.00\-0.40
 -1.60/-1.60~-0.80\-0.40
 -1.00/-1.00~-1.00\-0.40
 -1.60/-1.60~-0.40\-0.40
 -1.00/-1.00~-1.00\-1.00
 -80.00/-6.00~0.00\20.00
 -0.20/-0.10~0.00\0.00
 -2.00/-2.00~-1.90\-0.18
 -0.80/-0.60~-0.40\-0.20
 -0.96/-0.76~-0.56\-0.36
 -1.30/-1.10~-0.90\-0.70
 -1.62/-1.42~-1.22\-1.02
 -1.80/-1.60~-1.40\-1.20
 -4.00/-2.00~-2.00\0.00
 -24.00/-18.00~-6.00\-2.00
 -44.00/-38.00~-24.00\-16.00
 -240.00/-180.00~-60.00\-40.00
 -2400.00/-1800.00~-600.00\-200.00
 -160.00/-120.00~-120.00\-80.00
 -2400.00/-1800.00~-1800.00\-1200.00
 -9600.00/-7200.00~-7200.00\-4800.00
 -22.00/-14.00~-14.00\-6.00
 -78.00/-62.00~-56.00\-40.00
 -1140.00/-732.00~-730.00\-320.00
 
(26 rows)

-- Division by zero (should return null)
SELECT 0/b AS zero_div_b, b/0 AS b_div_zero FROM test_functions;
     zero_div_b      | b_div_zero 
---------------------+------------
 0.00/0.00~0.00\0.00 | 
                     | 
                     | 
                     | 
                     | 
                     | 
                     | 
                     | 
                     | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
                     | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
                     | 
                     | 
                     | 
                     | 
 0.00/0.00~0.00\0.00 | 
 0.00/0.00~0.00\0.00 | 
                     | 
(26 rows)

-- Complex expression that should be evaluated to b
SELECT b, ((1-(-b)-1)*b)/b AS should_be_b FROM test_functions;
                b                |           should_be_b            
---------------------------------+----------------------------------
 0.20/0.40~0.60\0.80             | 0.20/0.40~0.60\1.40
 0.20/0.50~0.50\0.80             | 0.20/0.50~0.50\1.61
 0.20/0.40~0.80\0.80             | 0.20/0.40~0.80\1.40
 0.20/0.50~0.50\0.50             | 0.20/0.50~0.50\1.50
 0.20/0.20~0.80\0.80             | 0.20/0.20~0.80\1.05
 0.50/0.50~0.50\0.50             | 0.50/0.50~0.50\1.50
 -10.00/0.00~3.00\40.00          | 
 0.00/0.00~0.05\0.10             | 
 0.09/0.95~1.00\1.00             | 0.09/0.95~1.00\2.85
 0.10/0.20~0.30\0.40             | 0.10/0.20~0.30\0.70
 0.18/0.28~0.38\0.48             | 0.18/0.28~0.38\0.92
 0.35/0.45~0.55\0.65             | 0.35/0.45~0.55\1.41
 0.51/0.61~0.71\0.81             | 0.51/0.61~0.71\1.88
 0.60/0.70~0.80\0.90             | 0.60/0.70~0.80\2.14
 0.00/1.00~1.00\2.00             | 
 1.00/3.00~9.00\12.00            | 1.00/3.00~9.00\15.75
 8.00/12.00~19.00\22.00          | 8.00/12.00~19.00\40.55
 20.00/30.00~90.00\120.00        | 20.00/30.00~90.00\157.50
 100.00/300.00~900.00\1200.00    | 100.00/300.00~900.00\1575.00
 40.00/60.00~60.00\80.00         | 40.00/60.00~60.00\185.00
 600.00/900.00~900.00\1200.00    | 600.00/900.00~900.00\2775.00
 2400.00/3600.00~3600.00\4800.00 | 2400.00/3600.00~3600.00\11100.00
 3.00/7.00~7.00\11.00            | 3.00/7.00~7.00\22.45
 20.00/28.00~31.00\39.00         | 20.00/28.00~31.00\87.10
 160.00/365.00~366.00\570.00     | 160.00/365.00~366.00\1168.73
                                 | 
(26 rows)

-- Function operators
SELECT (trapezoidal_function '1/2~3\4')+(trapezoidal_function '3/4~5\6') AS f_plus_f;
       f_plus_f       
----------------------
 4.00/6.00~8.00\10.00
(1 row)

SELECT (trapezoidal_function '1/2~3\4')-(trapezoidal_function '3/4~5\6') AS f_minus_f;
        f_minus_f        
-------------------------
 -2.00/-2.00~-2.00\-2.00
(1 row)

SELECT (trapezoidal_function '1/2~3\4')*(trapezoidal_function '3/4~5\6') AS f_mul_f;
        f_mul_f        
-----------------------
 3.00/8.00~15.00\32.00
(1 row)

SELECT (trapezoidal_function '1/2~3\4')/(trapezoidal_function '3/4~5\6') AS f_div_f;
       f_div_f       
---------------------
 0.33/0.50~0.60\1.17
(1 row)

SELECT max(trapezoidal_function '1/2~3\4', trapezoidal_function '3/4~5\6') AS max_f;
        max_f        
---------------------
 3.00/4.00~5.00\6.00
(1 row)

SELECT min(trapezoidal_function '1/2~3\4', trapezoidal_function '3/4~5\6') AS min_f;
        min_f        
---------------------
 1.00/2.00~3.00\4.00
(1 row)

CREATE TABLE test_functions_ext(a INT, b TRAPEZOIDAL_FUNCTION_EXT);
INSERT INTO test_functions_ext VALUES
  (1, '0.2/0.4~0.6\0.8 *>= .3'),
  (2, trapezoidal_function('1/2~3\4') *= .1),
  (3, trapezoidal_function('1/2~3\4') *<> 0),
  (4, trapezoidal_function('1/2~3\4') *> .9),
  (5, trapezoidal_function('1/2~3\4') *>= .5),
  (6, trapezoidal_function('1/2~3\4') *< .3),
  (7, trapezoidal_function('1/2~3\4') *<= .6);
-- Conversion
SELECT *, to_trapezoidal_function(b) as f FROM test_functions_ext;
 a |              b               |          f          
---+------------------------------+---------------------
 1 | 0.20/0.40~0.60\0.80 *>= 0.30 | 0.20/0.40~0.60\0.80
 2 | 1.00/2.00~3.00\4.00 *= 0.10  | 1.00/2.00~3.00\4.00
 3 | 1.00/2.00~3.00\4.00 *<> 0.00 | 1.00/2.00~3.00\4.00
 4 | 1.00/2.00~3.00\4.00 *> 0.90  | 1.00/2.00~3.00\4.00
 5 | 1.00/2.00~3.00\4.00 *>= 0.50 | 1.00/2.00~3.00\4.00
 6 | 1.00/2.00~3.00\4.00 *< 0.30  | 1.00/2.00~3.00\4.00
 7 | 1.00/2.00~3.00\4.00 *<= 0.60 | 1.00/2.00~3.00\4.00
(7 rows)

SELECT state_percentage('1,2', false);
 state_percentage 
------------------
 1,3
(1 row)

SELECT state_percentage('1,2', true);
 state_percentage 
------------------
 2,3
(1 row)

SELECT final_percentage('11,20');
 final_percentage 
------------------
             0.55
(1 row)

SELECT final_percentage('0,30');
 final_percentage 
------------------
                0
(1 row)

SELECT final_percentage('15,15');
 final_percentage 
------------------
                1
(1 row)

SELECT PERCENTAGE(a<.5) FROM test_zadeh;
 percentage 
------------
           
(1 row)

SELECT degree(.3, '.2/1~2\2.2'), degree('.2/1~2\2.2', .9);
 degree | degree 
--------+--------
  0.125 |  0.875
(1 row)

SELECT degreeff('1/2~3\4', '1/2~3\4'), degreeff('3/5~8\9', '1/2~3\4'), degreeff('1/2~3\4', '3/5~8\9');
 degreeff |     degreeff      |     degreeff      
----------+-------------------+-------------------
        1 | 0.333333343267441 | 0.333333343267441
(1 row)

-- Defuzzy
SELECT
    degree(to_trapezoidal_function(b), 1.5) AS degree,
    defuzzy(b, 1.5),
    defuzzy(1.5, b)
  FROM test_functions_ext;
 degree | defuzzy | defuzzy 
--------+---------+---------
      0 | f       | f
    0.5 | f       | f
    0.5 | t       | t
    0.5 | f       | f
    0.5 | t       | t
    0.5 | f       | f
    0.5 | t       | t
(7 rows)

-- Not defuzzy
SELECT
    degree(to_trapezoidal_function(b), 1.5) AS degree,
    notdefuzzy(b, 1.5),
    notdefuzzy(1.5, b)
  FROM test_functions_ext;
 degree | notdefuzzy | notdefuzzy 
--------+------------+------------
      0 | t          | t
    0.5 | t          | t
    0.5 | f          | f
    0.5 | t          | t
    0.5 | f          | f
    0.5 | t          | t
    0.5 | f          | f
(7 rows)

SELECT about_one();
      about_one      
---------------------
 0.00/1.00~1.00\2.00
(1 row)

